<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Performance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --pos:#198754; --neg:#dc3545; --ink:#495057; --muted:#6c757d;
      --border:#dee2e6; --bg:#f8f9fa; --shadow:0 2px 10px rgba(0,0,0,0.08);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--ink);padding:20px}
    .container{max-width:1400px;margin:0 auto;background:#fff;border:1px solid #e9ecef;border-radius:8px;box-shadow:var(--shadow);padding:30px}
    .title{font-size:2.2rem;font-weight:700;text-align:center;margin-bottom:24px}
    .panels{display:flex;gap:28px;align-items:flex-start}
    .left-panel,.right-panel{flex:1}
    .summary-table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:6px;overflow:hidden}
    .summary-table thead th{background:#6c757d;color:#fff;padding:12px 10px;font-size:13px}
    .summary-table td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:center}
    .summary-table tbody tr{cursor:pointer;transition:background .15s}
    .summary-table tbody tr:hover{background:#f1f3f4}
    .summary-table tbody tr.selected{background:#e3f2fd;border-left:3px solid #6c757d}
    .positive{color:var(--pos);font-weight:600}
    .negative{color:var(--neg);font-weight:600}
    .total-row{background:#f8f9fa;font-weight:700}
    .right-content{border:1px solid var(--border);border-radius:6px;padding:18px}
    .category-title{border-bottom:2px solid #6c757d;padding-bottom:8px;margin-bottom:14px}
    .trade-item{border:1px solid var(--border);border-radius:8px;padding:14px;margin:10px 0}
    .trade-header{display:flex;justify-content:space-between;gap:12px}
    .trade-info{flex:1;min-width:0}
    .trade-date{font-weight:700;margin-bottom:4px}
    .trade-action{font-size:13px;color:var(--muted);word-break:break-word}
    .trade-meta{font-size:12px;color:#868e96;margin-top:6px;line-height:1.3}
    .trade-controls{text-align:right;min-width:160px}
    .trade-amount{font-weight:800;font-size:16px;margin-bottom:8px;white-space:nowrap}
    .btn{background:#6c757d;color:#fff;border:0;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer}
    .btn-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
    .upload-section{background:#f8f9fa;border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:18px}
    .upload-box h3{text-align:center;margin-bottom:10px}
    .upload-hint{font-size:12px;color:var(--muted);text-align:center}
    .placeholder{color:var(--muted);text-align:center;padding:32px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Trading Performance Dashboard</h1>

    <div class="upload-section">
      <div class="upload-box">
        <h3>Import / Export</h3>
        <div class="btn-row">
          <input id="file-upload" type="file" accept=".csv,.xlsx,.xls" style="display:none"/>
          <button class="btn" onclick="document.getElementById('file-upload').click()">üìÑ Upload CSV/Excel File</button>
          <button class="btn" onclick="exportSummaryXLS()">‚¨áÔ∏è Export Summary (.xls)</button>
          <button class="btn" onclick="resetTrades()">üóëÔ∏è Reset Trades</button>
        </div>
        <p class="upload-hint">Upload your broker statement (CSV/XLSX). We‚Äôll parse trades, show summaries, and let you export.</p>
      </div>
    </div>

    <div class="panels">
      <div class="left-panel">
        <h2>Trading Summary</h2>
        <table class="summary-table">
          <thead>
            <tr>
              <th style="text-align:left">Category</th>
              <th>Trades</th>
              <th>Winning</th>
              <th>Win %</th>
              <th>Avg P&L</th>
              <th>Total P&L</th>
            </tr>
          </thead>
          <tbody id="summary-tbody"></tbody>
        </table>
      </div>

      <div class="right-panel">
        <h2>Trade Details & Customization</h2>
        <div id="trade-details" class="right-content">
          <div class="placeholder">
            <div style="font-size:42px;margin-bottom:10px">üìä</div>
            <div>Select a category on the left to view/edit trades.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   DATA MODEL
========================= */
let trades = [];
let selectedCategory = null;
let editingTrade = null;

const categories = {
  put_sales:        { name: 'Put Sale Option Trades',   color: '#198754' },
  assigned_shares:  { name: 'Assigned Shares from Puts',color: '#0d6efd' },
  stock_trades:     { name: 'Outright Stock Trades',    color: '#6f42c1' },
  asymmetric:       { name: 'Asymmetric Upside',        color: '#fd7e14' },
  hedging:          { name: 'Hedging Trades',           color: '#dc3545' },
  income:           { name: 'Dividends & Interest',     color: '#20c997' }
};

/* =========================
   HELPERS
========================= */
function escapeHtml(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}
function cur(n, d=2){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:d,maximumFractionDigits:d}).format(Number(n||0))}
function pct(n){return `${(n||0).toFixed(1)}%`}

function calculateCategoryStats(key){
  const list = trades.filter(t=>t.category===key);
  const totalTrades = list.length;
  const totalAmount = list.reduce((s,t)=>s+Number(t.amount||0),0);
  const winningTrades = list.filter(t=>Number(t.amount)>0).length;
  const winPct = totalTrades ? (winningTrades/totalTrades*100) : 0;
  const avgAmount = totalTrades ? (totalAmount/totalTrades) : 0;
  return {totalTrades, winningTrades, winPct, avgAmount, totalAmount};
}

function calculateOverallStats(){
  const totalTrades = trades.length;
  const totalAmount = trades.reduce((s,t)=>s+Number(t.amount||0),0);
  const winningTrades = trades.filter(t=>Number(t.amount)>0).length;
  const winPct = totalTrades ? (winningTrades/totalTrades*100) : 0;
  const avgAmount = totalTrades ? (totalAmount/totalTrades) : 0;
  return {totalTrades, winningTrades, winPct, avgAmount, totalAmount};
}

/* =========================
   LEFT: SUMMARY TABLE
========================= */
function updateSummaryTable(){
  const tbody = document.getElementById('summary-tbody');
  tbody.innerHTML = '';
  Object.entries(categories).forEach(([key, info])=>{
    const s = calculateCategoryStats(key);
    const tr = document.createElement('tr');
    tr.className = selectedCategory===key ? 'selected' : '';
    tr.onclick = ()=>{ selectedCategory = (selectedCategory===key?null:key); updateSummaryTable(); updateTradeDetails(); };
    tr.innerHTML = `
      <td style="text-align:left;font-weight:${selectedCategory===key?'700':'400'}">${escapeHtml(info.name)}</td>
      <td>${s.totalTrades}</td>
      <td>${s.winningTrades}</td>
      <td class="${s.winPct>=50?'positive':'negative'}">${pct(s.winPct)}</td>
      <td class="${s.avgAmount>=0?'positive':'negative'}">${cur(s.avgAmount)}</td>
      <td class="${s.totalAmount>=0?'positive':'negative'}">${cur(s.totalAmount)}</td>
    `;
    tbody.appendChild(tr);
  });

  const o = calculateOverallStats();
  const total = document.createElement('tr');
  total.className = 'total-row';
  total.innerHTML = `
    <td style="text-align:left">Total</td>
    <td>${o.totalTrades}</td>
    <td>${o.winningTrades}</td>
    <td class="${o.winPct>=50?'positive':'negative'}">${pct(o.winPct)}</td>
    <td class="${o.avgAmount>=0?'positive':'negative'}">${cur(o.avgAmount)}</td>
    <td class="${o.totalAmount>=0?'positive':'negative'}">${cur(o.totalAmount)}</td>
  `;
  tbody.appendChild(total);
}

/* =========================
   IMPORT HANDLERS
========================= */
document.getElementById('file-upload').addEventListener('change', handleFileUpload);

async function handleFileUpload(e){
  const file = e.target.files[0];
  if(!file) return;

  try{
    let rows;
    if(file.name.toLowerCase().endsWith('.csv')){
      rows = parseCSV(await file.text());
    }else{
      const wb = XLSX.read(await file.arrayBuffer(), {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(sheet, {defval:'', raw:false});
    }
    const parsed = await parseTradeData(rows);
    trades = trades.concat(parsed);
    selectedCategory = null;
    updateSummaryTable();
    updateTradeDetails();
    alert(`Imported ${parsed.length} trades.`);
  }catch(err){
    console.error(err);
    alert('Import failed. Make sure the file matches your statement format.');
  }finally{
    e.target.value='';
  }
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  if(!lines.length) return [];
  const headers = lines[0].split(',').map(h=>h.trim().replace(/"/g,''));
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const vals = lines[i].split(',').map(v=>v.trim().replace(/"/g,''));
    const row={}; headers.forEach((h,idx)=>row[h]=vals[idx]??'');
    rows.push(row);
  }
  return rows;
}

/* =========================
   PARSER: rows -> trades
========================= */
async function parseTradeData(rows){
  const out=[]; let id = trades.length ? Math.max(...trades.map(t=>t.id))+1 : 1;

  const money = v => v==null||v==='' ? NaN : parseFloat(String(v).replace(/\$/g,'').replace(/,/g,'').replace(/\((.*)\)/,'-$1'));
  const lower = v => String(v||'').toLowerCase();

  const premiumByTicker = Object.create(null);

  function extractTickerFromPut(desc, action){
    const s = String(desc||action||'');
    let m = s.match(/\bPUT\b\s*\(([^)]+)\)/i); if(m) return m[1].toUpperCase();
    m = s.match(/\(([A-Z.]+)\)/);             if(m) return m[1].toUpperCase();
    return null;
  }
  function extractTickerFromAssignment(action){
    const m = String(action||'').match(/Bought Assigned Puts in\s+([A-Z.]+)/i);
    return m ? m[1].toUpperCase() : null;
  }

  const getDate = r => r['Run Date'] || r['Date'] || r['Trade Date'] || r['Entry Date'] || '';
  rows.sort((a,b)=>String(getDate(a)).localeCompare(String(getDate(b))));

  for(const r of rows){
    const date = getDate(r);
    const action = String(r['Action']||'').trim();
    const description = String(r['Description'] || r['Symbol'] || '').trim();
    const qty = Number(r['Quantity']||0);
    const price = Number(r['Price']||0);
    const amt = money(r['Amount'] || r['P&L'] || r['Profit/Loss']);
    if(!date || !action) continue;

    const a = lower(action), d = lower(description);

    // Income
    if(a.includes('dividend') || a.includes('interest')){
      out.push({id:id++, date, action: description||action, amount: isNaN(amt)?0:amt, category:'income'});
      continue;
    }
    // Skip transfers/reinvest
    if(a.includes('electronic funds transfer')||a.includes('direct deposit')||a.includes('reinvestment')) continue;

    // Sold opening PUT ‚Üí premium
    if(a.includes('you sold opening transaction') && a.includes(' put')){
      const tkr = extractTickerFromPut(description, action);
      if(tkr) premiumByTicker[tkr]=(premiumByTicker[tkr]||0)+(isNaN(amt)?0:amt);
      out.push({id:id++, date, action: description||action, amount:isNaN(amt)?0:amt, category:'put_sales', ticker:tkr||undefined});
      continue;
    }

    // Calls (asymmetric)
    if(a.includes('you bought opening transaction') && a.includes(' call')){
      out.push({id:id++, date, action: description||action, amount:isNaN(amt)?0:amt, category:'asymmetric'});
      continue;
    }

    // Hedging catch
    if(a.includes(' put') && (a.includes(' qqq') || d.includes(' qqq'))){
      out.push({id:id++, date, action: description||action, amount:isNaN(amt)?0:amt, category:'hedging'});
      continue;
    }

    // Option closes / expirations
    if(a.includes('bought closing transaction') || a.includes('sold closing transaction') || a.startsWith('expired')){
      const cat = a.includes(' put') ? 'put_sales' : (a.includes(' call') ? 'asymmetric' : 'stock_trades');
      out.push({id:id++, date, action: description||action, amount:isNaN(amt)?0:amt, category:cat});
      continue;
    }

    // Assignments
    if(a.includes('bought assigned puts')){
      const tkr = extractTickerFromAssignment(action) || extractTickerFromPut(description, action) || undefined;
      const shares = Math.abs(qty)||0;
      const assignCost = Math.abs(isNaN(amt)?(shares*price):amt);
      const premium = tkr ? (premiumByTicker[tkr]||0) : 0;
      const netCost = shares ? (assignCost - premium) : 0;
      const avgCost = shares ? (netCost / shares) : 0;

      out.push({
        id:id++, date, action: description||action, category:'assigned_shares',
        amount: 0, // will be overwritten by live P&L
        ticker:tkr, assigned_shares:shares, assignment_cost:assignCost,
        premium_applied:premium, avg_cost:avgCost, strike:price||undefined
      });
      continue;
    }

    // Plain stock/ETF
    if(a.startsWith('you bought ') || a.startsWith('you sold ')){
      out.push({id:id++, date, action:description||action, amount:0, category:'stock_trades'});
      continue;
    }
  }
  return out;
}

/* =========================
   QUOTES via your API proxy
========================= */
async function getLivePrice(ticker){
  if(!ticker) return "N/A";
  try{
    const r = await fetch(`/api/quote?ticker=${encodeURIComponent(ticker)}`, {cache:'no-store'});
    if(!r.ok) return "N/A";
    const j = await r.json();
    return (j && typeof j.price==='number') ? j.price : "N/A";
  }catch(e){
    console.error('quote error', e);
    return "N/A";
  }
}

/* =========================
   RIGHT: TRADE DETAILS
   - shows Market + P&L (top-right)
   - writes live P&L back into trade.amount
   - updates left summary after rendering
========================= */
async function updateTradeDetails(){
  const el = document.getElementById('trade-details');
  if(!selectedCategory){
    el.innerHTML = `<div class="placeholder"><div style="font-size:42px;margin-bottom:10px">üìä</div><div>Select a category on the left to view/edit trades.</div></div>`;
    return;
  }
  const info = categories[selectedCategory];
  const list = trades.filter(t=>t.category===selectedCategory);

  let html = `<h3 class="category-title" style="color:${info.color}">${escapeHtml(info.name)}</h3><div>`;
  for(const t of list){
    let meta = '';
    const hasOptionMeta = (t.ticker || t.expiry || t.type || typeof t.strike!=='undefined');

    if(hasOptionMeta){
      meta += `<div class="trade-meta">
        ${t.ticker?`Ticker: ${escapeHtml(t.ticker)}`:''}
        ${t.type?` ‚Ä¢ Type: ${escapeHtml(t.type)}`:''}
        ${typeof t.strike!=='undefined' && t.strike!==null && t.strike!=='' ? ` ‚Ä¢ Strike: ${escapeHtml(String(t.strike))}`:''}
        ${t.expiry?` ‚Ä¢ Expiry: ${escapeHtml(t.expiry)}`:''}
      </div>`;
    }

    // Assigned shares ‚Üí fetch live price & compute P&L
    let amountForCard = Number(t.amount)||0;
    if(t.category==='assigned_shares' && t.ticker && typeof t.avg_cost==='number'){
      const shares = Number(t.assigned_shares||0);
      const live = await getLivePrice(t.ticker);
      const marketLine = (typeof live==='number') ? `Market: ${cur(live)}` : `Market: N/A`;

      if(typeof live==='number' && shares){
        const pnl = (live - t.avg_cost) * shares;
        t.live_price = live;
        t.live_pnl = pnl;
        t.amount = pnl;                 // write back so summary uses it
        amountForCard = pnl;            // top-right amount
      }

      meta += `
        <div class="trade-meta">
          ${t.ticker?`Ticker: ${escapeHtml(t.ticker)}`:''}
          ${t.assigned_shares?` ‚Ä¢ Assigned: ${escapeHtml(String(t.assigned_shares))} sh`:''}
          ${typeof t.premium_applied==='number'?` ‚Ä¢ Premium applied: ${cur(t.premium_applied)}`:''}
          ${typeof t.assignment_cost==='number'?` ‚Ä¢ Assignment cost: ${cur(t.assignment_cost)}`:''}
          ${typeof t.avg_cost==='number'?` ‚Ä¢ Avg cost: ${cur(t.avg_cost)}`:''}
        </div>
        <div class="trade-meta">${marketLine}</div>
      `;
    }

    html += `
      <div class="trade-item" id="trade-${t.id}">
        <div class="trade-header">
          <div class="trade-info">
            <div class="trade-date">${escapeHtml(t.date)}</div>
            <div class="trade-action">${escapeHtml(t.action)}</div>
            ${meta}
          </div>
          <div class="trade-controls">
            <div class="trade-amount ${amountForCard>=0?'positive':'negative'}">${cur(amountForCard)}</div>
            <button class="btn" onclick="editTrade(${t.id})">Edit</button>
          </div>
        </div>
      </div>
    `;
  }
  html += `</div>`;
  el.innerHTML = html;

  // refresh the left summary to reflect any newly written live P&L
  updateSummaryTable();
}

/* =========================
   EDIT INLINE
========================= */
function editTrade(id){
  editingTrade = id;
  const t = trades.find(x=>x.id===id); if(!t) return;
  const node = document.getElementById(`trade-${id}`);
  if(!node) return;

  node.innerHTML = `
    <div class="trade-header">
      <div class="trade-info">
        <div class="trade-date">${escapeHtml(t.date)}</div>
        <div class="trade-action">${escapeHtml(t.action)}</div>
      </div>
      <div class="trade-controls">
        <div style="margin-bottom:6px">Edit</div>
        <select id="cat-${id}" class="btn" style="background:#fff;color:#000;border:1px solid var(--border);margin-bottom:6px">
          ${Object.entries(categories).map(([k,v])=>`<option value="${k}" ${k===t.category?'selected':''}>${escapeHtml(v.name)}</option>`).join('')}
        </select>
        <input id="amt-${id}" type="number" step="0.01" value="${Number(t.amount)||0}" class="btn" style="background:#fff;color:#000;border:1px solid var(--border);width:140px;margin-bottom:6px"/>
        <div>
          <button class="btn" onclick="saveTradeEdit(${id})">Save</button>
          <button class="btn" onclick="updateTradeDetails()">Cancel</button>
        </div>
      </div>
    </div>
  `;
}
function saveTradeEdit(id){
  const cat = document.getElementById(`cat-${id}`).value;
  const amt = parseFloat(document.getElementById(`amt-${id}`).value)||0;
  trades = trades.map(t=>t.id===id?{...t, category:cat, amount:amt}:t);
  editingTrade=null;
  updateSummaryTable();
  updateTradeDetails();
}

/* =========================
   EXPORT (Excel-compatible HTML)
========================= */
function exportSummaryXLS(){
  const overall = calculateOverallStats();
  const dateStr = new Date().toISOString().slice(0,10);

  const summaryRows = Object.entries(categories).map(([k,info])=>{
    const s = calculateCategoryStats(k);
    return `<tr>
      <td style="text-align:left">${escapeHtml(info.name)}</td>
      <td>${s.totalTrades}</td>
      <td>${s.winningTrades}</td>
      <td>${s.winPct.toFixed(1)}%</td>
      <td>${(s.avgAmount||0).toFixed(2)}</td>
      <td>${(s.totalAmount||0).toFixed(2)}</td>
    </tr>`;
  }).join('');

  const summaryTable = `
    <table border="1" cellspacing="0" cellpadding="5" style="border-collapse:collapse;font-family:Segoe UI,Tahoma,sans-serif;font-size:12px">
      <thead style="background:#6c757d;color:#fff">
        <tr><th>Category</th><th>Trades</th><th>Winning</th><th>Win %</th><th>Avg P&L</th><th>Total P&L</th></tr>
      </thead>
      <tbody>
        ${summaryRows}
        <tr style="font-weight:bold;background:#f3f4f6">
          <td style="text-align:left">Total</td>
          <td>${overall.totalTrades}</td>
          <td>${overall.winningTrades}</td>
          <td>${overall.winPct.toFixed(1)}%</td>
          <td>${(overall.avgAmount||0).toFixed(2)}</td>
          <td>${(overall.totalAmount||0).toFixed(2)}</td>
        </tr>
      </tbody>
    </table>`;

  const categorySections = Object.entries(categories).map(([k,info])=>{
    const rows = trades.filter(t=>t.category===k).map(t=>{
      if(k==='assigned_shares'){
        return `<tr>
          <td>${escapeHtml(t.date)}</td>
          <td>${escapeHtml(t.ticker||'')}</td>
          <td style="text-align:right">${escapeHtml(String(t.assigned_shares||''))}</td>
          <td style="text-align:right">${typeof t.premium_applied==='number'?(t.premium_applied||0).toFixed(2):''}</td>
          <td style="text-align:right">${typeof t.assignment_cost==='number'?(t.assignment_cost||0).toFixed(2):''}</td>
          <td style="text-align:right">${typeof t.avg_cost==='number'?(t.avg_cost||0).toFixed(2):''}</td>
          <td style="text-align:right">${(Number(t.amount)||0).toFixed(2)}</td>
        </tr>`;
      }
      return `<tr>
        <td>${escapeHtml(t.date)}</td>
        <td>${escapeHtml(t.action)}</td>
        <td style="text-align:right">${(Number(t.amount)||0).toFixed(2)}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="7" style="text-align:center;color:#6c757d">No trades</td></tr>`;

    const thead = k==='assigned_shares'
      ? `<thead style="background:#e9ecef"><tr>
           <th>Date</th><th>Ticker</th><th>Assigned (sh)</th>
           <th>Premium Applied</th><th>Assignment Cost</th><th>Avg Cost/Share</th><th>P&L</th>
         </tr></thead>`
      : `<thead style="background:#e9ecef"><tr><th>Date</th><th>Action</th><th>Amount</th></tr></thead>`;

    return `<h3 style="margin:18px 0 6px 0">${escapeHtml(info.name)}</h3>
            <table border="1" cellspacing="0" cellpadding="5" style="border-collapse:collapse;font-family:Segoe UI,Tahoma,sans-serif;font-size:12px">
              ${thead}<tbody>${rows}</tbody>
            </table>`;
  }).join('');

  const html = `
    <html><head><meta charset="UTF-8"><title>Trading Summary</title></head>
    <body>
      <h2 style="font-family:Segoe UI,Tahoma,sans-serif">Trading Summary Export ‚Äî ${dateStr}</h2>
      ${summaryTable}
      <div style="height:16px"></div>
      ${categorySections}
    </body></html>`;

  const blob = new Blob([html], {type:'application/vnd.ms-excel;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `trading-summary-${dateStr}.xls`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   RESET
========================= */
function resetTrades(){
  if(!confirm('Wipe all trades?')) return;
  trades = []; selectedCategory=null; editingTrade=null;
  updateSummaryTable(); updateTradeDetails();
}

/* =========================
   BOOT
========================= */
updateSummaryTable();
updateTradeDetails();
</script>
</body>
</html>
